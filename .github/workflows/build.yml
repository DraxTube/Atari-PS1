name: Build DraxTube PS1 Emulator

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Toolchain and SDK
      run: |
        # 1. Installa dipendenze base
        sudo apt-get update
        sudo apt-get install -y gcc-mipsel-linux-gnu make git unzip wget

        # 2. Scarica una versione leggera di PSn00bSDK pre-compilata
        # Usiamo una release stabile per evitare errori di compilazione
        wget https://github.com/Lameguy64/PSn00bSDK/releases/download/v0.24/PSn00bSDK-0.24-Linux.tar.gz
        tar -xzf PSn00bSDK-0.24-Linux.tar.gz
        
        # 3. Imposta le variabili d'ambiente per questa sessione
        echo "PSN00BSDK_LIBS=$(pwd)/PSn00bSDK" >> $GITHUB_ENV
        echo "PATH=$(pwd)/PSn00bSDK/bin:$PATH" >> $GITHUB_ENV

    - name: Compile Emulator
      run: |
        # Definiamo i path manualmente per sicurezza
        export SDK_PATH=$(pwd)/PSn00bSDK
        
        # Compila usando il GCC MIPS standard di Linux ma con le librerie SDK
        mipsel-linux-gnu-gcc \
        -I$SDK_PATH/include -L$SDK_PATH/lib \
        -T$SDK_PATH/ldscripts/psx-exe.ld \
        -O2 -G0 -mno-abicalls -fno-pic -Wall \
        main.c -o draxtube_atari.elf \
        -lpsn00b -lc -lgpu -lgte -letc -lapi
        
        # Converti in EXE (l'SDK include lo strumento elf2exe, ma se manca usiamo objcopy)
        # Se elf2exe non c'Ã¨, usiamo questo trucco standard per PS1:
        mipsel-linux-gnu-objcopy -O binary draxtube_atari.elf draxtube_atari.exe

    - name: Upload PS1 Executable
      uses: actions/upload-artifact@v4
      with:
        name: DraxTube-Atari-PS1
        path: draxtube_atari.exe
