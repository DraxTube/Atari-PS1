name: Build DraxTube PS1 Emulator

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install MIPS Compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-mipsel-linux-gnu binutils-mipsel-linux-gnu make wget

    - name: Setup Minimal PS1 SDK
      run: |
        # Scarichiamo le librerie essenziali (tiny-sdk) per PS1
        git clone https://github.com/grumpycoders/pcsx-redux.git
        # Copiamo solo gli header necessari per far compilare il tuo main.c
        mkdir -p sdk/include
        cp -r pcsx-redux/src/mips/common/syscalls/*.h sdk/include/ || true
        # Nota: Usiamo un approccio "bare metal" più semplice per l'emulatore

   - name: Compile Emulator
      run: |
        # Aggiungiamo -mfp32 e -msoft-float perché la PS1 non ha FPU
        mipsel-linux-gnu-gcc -march=r3000 -mabi=32 -mfp32 -msoft-float -O2 \
        -ffreestanding -nostdlib -Ttext 0x80010000 \
        main.c -o draxtube_atari.elf -lgcc
        
        # Convertiamo l'ELF in un binario puro per la PS1
        mipsel-linux-gnu-objcopy -O binary draxtube_atari.elf draxtube_atari.exe

    - name: Upload PS1 Executable
      uses: actions/upload-artifact@v4
      with:
        name: DraxTube-Atari-PS1
        path: draxtube_atari.exe
